\documentclass[11pt]{article}
\usepackage{lipsum} % for dummy text only
\usepackage{longtable}
\setlength{\arrayrulewidth}{1.2pt}

\usepackage[
  paperwidth=3in,
  paperheight=3in,
  margin=.5in,
  showframe
]{geometry}

\usepackage{zref-abspage}[2010/03/26]

\usepackage{multirow}


\usepackage{array}% http://ctan.org/pkg/array


\usepackage{xparse}


\usepackage{expl3}

\ExplSyntaxOn


\seq_new:N \TopPath
\prop_new:N \TopText

\prop_new:N \TopNums
\prop_new:N \TopCellHeightsOutput

\prop_new:N \TopCellHeightsInput
\clist_set:Nn \l_tmpa_clist {3,0,0,4,0,0,0}
\prop_gput:NnV \TopCellHeightsInput { 1 } \l_tmpa_clist
\clist_set:Nn \l_tmpa_clist {2,0,1,1,2,0,1}
\prop_gput:NnV \TopCellHeightsInput { 2 } \l_tmpa_clist
\clist_set:Nn \l_tmpa_clist {1,1,1,1,2,0,1}
\prop_gput:NnV \TopCellHeightsInput { 3 } \l_tmpa_clist
%% \prop_show:N \TopCellHeightsInput


\int_new:N \TopCol

\cs_new:Npn \GetCurCelHeight #1 {
  \prop_get:NVNTF \TopCellHeightsInput \TopCol \l_tmpa_tl {
    \clist_set:NV \l_tmpa_clist \l_tmpa_tl
  } {
    \clist_clear:N \l_tmpa_clist
  }
  \clist_pop:NNTF \l_tmpa_clist \l_tmpb_tl {} { \tl_set:Nn \l_tmpb_tl { 1 } }
  \prop_gput:NVV \TopCellHeightsInput \TopCol \l_tmpa_clist
  \int_set:Nn { #1 } \l_tmpb_tl
}


\cs_new:Npn \SetTopic #1#2 {

  % reset stack up until #1
  \seq_if_in:NnTF \TopPath {#1} {
    \bool_do_until:Nn \l_tmpa_bool {
      \seq_gpop:NN \TopPath \l_tmpa_tl
      \prop_gpop:NoN \TopText \l_tmpa_tl \l_tmpb_tl
      \tl_set:Nn \l_tmpb_tl {#1}
      \bool_gset:Nn \l_tmpa_bool { \tl_if_eq_p:NN \l_tmpa_tl \l_tmpb_tl }
    }
  } {}


  \prop_get:NVNTF \TopNums \TopCol \l_tmpa_tl {
    \clist_set:NV \l_tmpa_clist \l_tmpa_tl
  } {
    \clist_clear:N \l_tmpa_clist
  }
  \clist_push:Nn \l_tmpa_clist { 1 }
  \prop_gput:NVV \TopNums \TopCol \l_tmpa_clist
  %% \prop_show:N \TopNums

  %%%
  \GetCurCelHeight \l_tmpb_int
  [\int_use:N \l_tmpb_int]
  %%%

  \seq_gpush:Nn \TopPath {#1}
  \prop_gput:Nnn \TopText {#1} {#2}
  \prop_item:Nn \TopText {#1}

  %% \multirow{\int_use:N \l_tmpb_int}{*}{\prop_item:Nn \TopText {#1}}
}

\msg_new:nnnn {tabloid} {invalid-index} {
  You~tried~to~use~an~uninitialized~topic~index~\msg_line_context:.
} {TODO}



\cs_new:Npn \GetTopic #1 {

  \seq_if_in:NnTF \TopPath {#1} {


    \prop_get:NVNTF \TopNums \TopCol \l_tmpa_tl {
      \clist_set:NV \l_tmpa_clist \l_tmpa_tl
    } {
      \ERROR
    }
    \clist_pop:NN \l_tmpa_clist \l_tmpa_tl
    \int_set:Nn \l_tmpa_int \l_tmpa_tl
    \int_incr:N \l_tmpa_int
    \clist_push:NV \l_tmpa_clist \l_tmpa_int
    \prop_gput:NVV \TopNums \TopCol \l_tmpa_clist
    %% \prop_show:N \TopNums

    %%%
    \GetCurCelHeight \l_tmpb_int
    [\int_use:N \l_tmpb_int]
    %%%

    %% \prop_item:Nn \TopText {#1}
  } {
    \msg_error:nn {tabloid} {invalid-index}
  }
}

\cs_new:Npn \SetupConsumable {
  %% \prop_show:N \TopNums
  %% \prop_show:N \TopCellHeightsOutput
  \prop_map_inline:Nn \TopNums {
    \tl_set:Nn \l_tmpa_tl {##1}
    \clist_set:Nn \l_tmpa_clist {##2}
    \clist_reverse:N \l_tmpa_clist
    % empty tmp list
    \clist_gclear:N \l_tmpb_clist
    \clist_map_inline:Nn \l_tmpa_clist {
      % store column index
      \int_set:Nn \l_tmpa_int { ####1 }
      \clist_gpush:NV \l_tmpb_clist \l_tmpa_int
      \int_while_do:nNnn { \l_tmpa_int } { > } { 1 } {
        \clist_gpush:Nn \l_tmpb_clist { 0 }
        \int_gdecr:N \l_tmpa_int
      }
    }
    \clist_reverse:N \l_tmpb_clist
    \prop_gput:NVV \TopCellHeightsOutput \l_tmpa_tl \l_tmpb_clist
  }

  %% \prop_show:N \TopNums
  %% \prop_show:N \TopCellHeightsOutput
}


%% %% \prop_gput:NnV \TopTabHeightsInput { T1 } {{3,0,0,4,0,0,0},{2,0,1,1,2,0,1},{1,1,1,1,2,0,1}}

%% \iow_new:N \l_my_stream

%% \cs_new:Nn \TopTabRead:n {
%%   \ior_open:Nn \l_my_stream {#1.toptab}
%%   \ior_get:NN  \l_my_stream \l_tmpa_tl
%%   \ior_close:N \l_my_stream
%%   \l_tmpa_tl
%% }

%% \prop_new:N \TopTabHeightsInput

%% %% \TopTabRead:n {seed3}
%% \prop_gput:Nnn \TopTabHeightsInput { T1 } {{3,0,0,4,0,0,0},{2,0,1,1,2,0,1},{1,1,1,1,2,0,1}}

%% \cs_new:Nn \TopTabWrite:n {
%%   \iow_open:Nn \l_my_stream {#1.toptab}
%%   \prop_get:NnN \TopTabHeightsInput { T1 } \l_tmpa_tl
%%   \clist_set:NV \l_tmpa_clist \l_tmpa_tl
%%   \iow_now:Nx \l_my_stream {
%%     \noexpand\prop_gput:Nnn \noexpand\TopTabHeightsInput { T1 }{ \l_tmpa_tl }
%%   }
%%   \iow_close:N \l_my_stream
%% }

%% \TopTabWrite:n {seed3}


\NewDocumentCommand{\Topic}{o}{%
  \IfValueTF{#1}{\SetTopic{\SCol}{#1}}{\GetTopic{\SCol}}%
}

\newcounter{TopCol}\newcounter{TopRow}
\newcolumntype{T}{>{\int_gincr:N \TopCol}}
\newcolumntype{F}{>{\int_gset:Nn \TopCol {1}}}

\DeclareExpandableDocumentCommand{\Tcline}{m}{
  %% \noalign{\CLINE_split:n { #1 } }
}

\cs_new_protected:Nn \CLINE_split:n {
  \clist_clear:N \l_tmpb_clist
  \prop_map_inline:Nn \TopCellHeightsInput {
    \tl_set:Nn \l_tmpa_tl {##1}
    % get first element as integer A
    \clist_set:Nn \l_tmpa_clist {##2}
    \clist_pop:NN \l_tmpa_clist \l_tmpb_tl
    \int_set:Nn \l_tmpa_int \l_tmpb_tl
    % if integer A is zero, skip
    \int_compare:nNnTF { \l_tmpa_int } { = } { 0 } {} {
      \clist_gpush:NV \l_tmpb_clist \l_tmpa_tl
    }
  }

  %% \clist_show:N \l_tmpb_clist
  \clist_sort:Nn \l_tmpb_clist {
    \int_compare:nNnTF { ##1 } { > } { ##2 } { \sort_return_swapped: } { \sort_return_same: }
  }
  \clist_pop:NNTF \l_tmpb_clist \l_tmpb_tl {} { \tl_set:Nn \l_tmpb_tl { 4 } }

  \tl_gset:Nx \g_tmpa_tl { \noexpand\cline{\l_tmpb_tl-#1} }
  \group_insert_after:N \g_tmpa_tl
}



\NewDocumentCommand{\SCol}{}{%
  \int_use:N \TopCol
  %% \setcounter{TopCol}{1}%\stepcounter{TopRow}
}

\NewDocumentCommand{\TNLine}{}{%
  \tabularnewline
  %% \setcounter{TopCol}{1}%\stepcounter{TopRow}
}

%% \ExplSyntaxOff

\begin{document}


\clist_set:Nn \l_tmpa_clist {
  {3,0,0,4,0,0,0},
  {2,0,1,1,2,0,1},
  {1,1,1,1,2,0,1}
}

%% \clist_show:N \l_tmpa_clist

%% \SetFile{wot}


% 3 2 1 0 0 1 0 1 1 3 1 1 0 2 2 0 0 0

% R#: 1 2 3 4 5 6 7 8 9
% L1: + - - + - - b - -
% L1: 3 0 0 3 0 0 3 0 0

%% \TNLine


\begin{longtable}{|Fl|Tl|Tl|Tl|}       
 \Tcline{4} \Topic[T1] & \Topic[ST1] & \Topic[SST1] & A \\
 \Tcline{4} \Topic     & \Topic      & \Topic[SST2] & B \\ 
 \Tcline{4} \Topic     & \Topic[ST2] & \Topic[SST3] & C \\ 
 \Tcline{4} \Topic[T2] & \Topic[ST3] & \Topic[SST4] & D \\ 
 \Tcline{4} \Topic     & \Topic[ST4] & \Topic[SST5] & E \\ 
 \Tcline{4} \Topic     & \Topic      & \Topic       & F \\
 \Tcline{4} \Topic     & \Topic[ST5] & \Topic[SST6] & F \\
 \hline
\end{longtable}

\SetupConsumable

%% \prop_show:N \TopNums

\end{document}
